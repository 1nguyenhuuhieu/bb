<script>
    var is_show_modal = false;
    var allow_show_modal = false;
    var modal = document.getElementById('chatModal');
    var chatModal = new bootstrap.Modal(modal);
    var modalStatus = bootstrap.Modal.getInstance(modal);
    var chat_api = 'http://' + '{{ request.get_host }}' + '/chat/';
    var mess0, mess1, lastSender1, lastSender0, date1, date0, lastMessId;
    var getMessInterval;
    var tempMessId = '{{ mess.id }}'

    var is_run_updatemess = false;

    function getMessRealtime() {
        fetch(chat_api)
            .then(response => response.json())
            .then(data => {
                lastMessId = data[0]['id'];
                if (tempMessId != lastMessId) {
                    tempMessId = lastMessId;
                    updateMess(data);
                }
                else {
                    if (!is_run_updatemess) {
                        is_run_updatemess = true;
                        updateMess(data);

                    }
                }
            }
            );
    }

    function updateMess(data) {
        mess0 = data[0]['mess'];
        mess1 = data[1]['mess'];
        lastSender1 = data[1]['sender'];
        lastSender0 = data[0]['sender'];
        date1 = new Date(data[1]['created']);
        date0 = new Date(data[0]['created']);

        document.getElementById('mess0').innerHTML = mess0;
        document.getElementById('mess1').innerHTML = mess1;

        date1 = date1.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'numeric', year: 'numeric' });
        document.getElementById('lastseen1').innerHTML = date1;
        date0 = date0.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'numeric', year: 'numeric' });
        document.getElementById('lastseen0').innerHTML = date0;

        if (lastSender1 == 1) {
            document.getElementById('lastsender1').innerHTML = '<i class="far fa-heart text-danger"></i>';
        }
        else if (lastSender1 == 2) {
            document.getElementById('lastsender1').innerHTML = '<i class="far fa-heart text-primary"></i>';
        }

        if (lastSender0 == 1) {
            document.getElementById('lastsender0').innerHTML = '<i class="far fa-heart text-danger"></i>';
        }
        else {
            document.getElementById('lastsender0').innerHTML = '<i class="far fa-heart text-primary"></i>';
        }

        if (data[0]['file']) {
            document.getElementById('image0').src = data[0]['file']
        }
        else {
            var accor = document.getElementById('accordionFlushExample0');
            if (accor) {
                accor.style.display = 'none'
            }
        }
        if (data[1]['file']) {
            document.getElementById('image1').src = data[1]['file']
        }
        else {
            var accor = document.getElementById('accordionFlushExample0');
            if (accor) {
                accor.style.display = 'none'
            }
        }
    }

    function function_first() {
        allow_show_modal = true;
    }
    function function_second() {
        if (allow_show_modal) {
            chatModal.show();
            allow_show_modal = false;
        }
    }
    function addCaption() {
        var mess_T = document.getElementById('exampleFormControlTextarea1').value;
        document.getElementById('imageCaption').value = mess_T;
    };

    function submitForm() {

        $("#chatForm").submit(function (event) {
            $.ajax({
                type: "POST",
                url: "{% url 'ajaxChat' %}",
                data: {
                    'mess': $('#exampleFormControlTextarea1').val()
                },
                success: function () {
                    $('#message').html("OK")
                    $('#exampleFormControlTextarea1').val('')
                }
            });
            return false; //<---- move it here
        });

    };

    function autoReloadPage(timesleep) {

        //close modal if not event    
        var time = new Date().getTime();
        $(document).bind("mousemove keypress", function (e) {
            time = new Date().getTime();
        });
        function refresh() {
            if (new Date().getTime() - time >= timesleep)
                location.reload();
            else
                setTimeout(refresh, 10000);
        }
        setTimeout(refresh, 10000);

    };

    function autocloseModal(timewait) {
        //close modal if not event    
        var time = new Date().getTime();
        $("#chatModal").bind("mousemove keypress", function (e) {
            time = new Date().getTime();
        });
        function refresh() {
            if (new Date().getTime() - time >= timewait) {
                chatModal.hide();
            }

            else
                setTimeout(refresh, 10000);
        }
        setTimeout(refresh, 10000);
    }

    $(document).ready(function () {
        // autoreload page after 30 minutes
        autoReloadPage(300000);
        // lastsender interval instance
        $('#chatModal').on('hidden.bs.modal', function () {
            clearInterval(getMessInterval);
            lastSenderInterval = setInterval(getSender, 500);
        });
        $('#chatModal').on('show.bs.modal', function () {
            clearInterval(lastSenderInterval);
            getMessInterval = setInterval(getMessRealtime, 500);
            // auto close after 1 minute
            autocloseModal(60000);
        });

        submitForm();

    });

</script>